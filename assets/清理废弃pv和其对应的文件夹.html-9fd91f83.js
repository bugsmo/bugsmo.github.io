import{_ as s,o as a,c as n,a as e}from"./app-8ca7f52c.js";const p={},t=e(`<h1 id="清理废弃-pv-和其对应的文件夹" tabindex="-1"><a class="header-anchor" href="#清理废弃-pv-和其对应的文件夹" aria-hidden="true">#</a> 清理废弃 pv 和其对应的文件夹</h1><p>pv 是 k8s 中重要的重要的存储资源。既然是存储，那就涉及占用磁盘空间。在使用 k8s 集群的过程中，如果不注意清理废弃 pv，那么就很容易积累大量垃圾 pv，不仅不方便 k8s 的管理，还可能导致磁盘空间不足。</p><p>本文以由 storage class 动态供应的 pv 为例，演示废弃 pv 和 nfs 服务器上对应文件夹的清理。</p><h2 id="导出废弃-pv-在-nfs-服务器上的对应路径" tabindex="-1"><a class="header-anchor" href="#导出废弃-pv-在-nfs-服务器上的对应路径" aria-hidden="true">#</a> 导出废弃 pv 在 nfs 服务器上的对应路径</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kubectl get <span class="token function">pv</span> <span class="token punctuation">\\</span>
	<span class="token parameter variable">-o</span> custom-columns<span class="token operator">=</span>STATUS:.status.phase,<span class="token environment constant">PATH</span>:.spec.nfs.path <span class="token punctuation">\\</span>
	<span class="token operator">|</span><span class="token function">grep</span> Released  <span class="token punctuation">\\</span>
	<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span> <span class="token punctuation">\\</span>
	<span class="token operator">&gt;</span> <span class="token number">200</span>.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的 <code>200.txt</code> 为存储路径信息的文本，因本集群的 master 节点的内网 IP 为 <code>192.168.130.200</code>，因此命名为 <code>200.txt</code>，在自己的清理过程中，您可以任意命名这个文件。</p><p>导出的文本：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>/volume2/kubesphere-devops-system-devops-jenkins-pvc-09188c53-a4a5-4e2f-994b-ab97c59d386b
/volume2/kubesphere-devops-system-data-sonarqube-postgresql-0-pvc-19092a4c-a12b-4201-a359-4094d2918884
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
/volume2/default-pvc-43490a5e64-pvc-2d454bf7-8b4b-4e2a-9e2a-4956d564c00e
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="清理-k8s-中的废弃-pv" tabindex="-1"><a class="header-anchor" href="#清理-k8s-中的废弃-pv" aria-hidden="true">#</a> 清理 k8s 中的废弃 pv</h2><p>将下面的代码写入文件，并运行，即可清理 pv。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">whiteList</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span>kubectl get <span class="token function">pv</span> <span class="token operator">|</span><span class="token function">grep</span>  Released <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">&#39;{print $1}&#39;</span><span class="token variable">\`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">\${whiteList}</span>&quot;</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> line
<span class="token keyword">do</span>
  kubectl patch <span class="token function">pv</span> <span class="token variable">\${line}</span>  <span class="token parameter variable">-p</span> <span class="token string">&#39;{&quot;spec&quot;:{&quot;persistentVolumeReclaimPolicy&quot;:&quot;Delete&quot;}}&#39;</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="清理-nfs-服务器上的废弃文件" tabindex="-1"><a class="header-anchor" href="#清理-nfs-服务器上的废弃文件" aria-hidden="true">#</a> 清理 nfs 服务器上的废弃文件</h2><p>将第 1 步生成的文本文件处理为以下格式</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>/volume2/archived-kubesphere-devops-system-devops-jenkins-pvc-09188c53-a4a5-4e2f-994b-ab97c59d386b
/volume2/archived-kubesphere-devops-system-data-sonarqube-postgresql-0-pvc-19092a4c-a12b-4201-a359-4094d2918884
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
/volume2/archived-default-pvc-43490a5e64-pvc-2d454bf7-8b4b-4e2a-9e2a-4956d564c00e
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>因为 pv 删除后自动归档会添加前缀 <code>archived-</code>，删除前最好抽选一个目录来验证。</p></div><p>将下面的代码写入 nfs 服务器，并运行\${脚本路径} \${文本路径}，如 ./cleaner.sh 200.txt，即可以清理废弃文件。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">whiteList</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span><span class="token function">cat</span> $1<span class="token variable">\`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">\${whiteList}</span>&quot;</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> line
<span class="token keyword">do</span>
  <span class="token function">rm</span> <span class="token parameter variable">-rf</span>  <span class="token string">&quot;<span class="token variable">$line</span>&quot;</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>删除前可以修改 <code>rm -rf</code> 命令为 <code>ls -d</code>，确认每个目录都是正确的。</p></div>`,18),i=[t];function l(c,o){return a(),n("div",null,i)}const r=s(p,[["render",l],["__file","清理废弃pv和其对应的文件夹.html.vue"]]);export{r as default};
